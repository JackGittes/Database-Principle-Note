## 数据库原理与应用 第三十五讲 文件组织

- 作者：**赵明心**
- 日期：**2019年8月18日**

---

### **4.3.1 文件组织**

硬盘属于块设备，所谓块设备是以物理块为单位的，在操作系统层是一块一块读写的，一块在UNIX操作系统缺省是1024个字节，在对磁盘进行读写的时候，需要寻道，寻道的原子层次就是一个块，一个读写要么成功要么失败。硬盘是一个块设备，操作系统存储在块设备上，在数据库底层读写的时候也是按照块进行的，而不是字节。存储在物理磁盘上的某个关系，就是一个文件，关系对应的文件就是用物理块组织的，在一个关系中，一条元组有100个字节，一个物理块就可以放置10个元组。存的时候就是一个物理块一个物理块存，查询的时候也是一个物理块一个物理块进行。

查询的时候用的元组大于15%就可以视查询几乎所有的文件？就是因为按照统计规律，当查询15%元组的时候，差不多元组会散布在这个关系所在的所有物理块当中，也就是为了找到15%的元组，基本需要读取这个关系的所有块。

第二种访问类型是查找特定元组，例如学号是多少多少的学生。第三种是访问特定的一些元组，不是一条，例如查找姓名张三的学生，由于可能存在重名，所以能匹配上的可能不止一个，但也不会很多。第四种是范围查询，例如查找学生年龄在16~19岁之间的学生，这个时候查询结果也是不一定的，需要根据范围中实际匹配上的元组数来决定。第五种是更新，前四种都是读操作，最后一个是写操作。

这样我们大致把一个关系型数据库底层的访问类型分成了五种，在一个关系型数据库中的底层访问结构？实际最常见的是堆文件。

- 堆文件是最简单的文件组织方式，所谓堆文件就是随着数据的插入，不停往文件末尾插入。在堆文件中访问数据，只能做顺序扫描，最坏情况就是扫描到尾部这是一个最简单常见的方式，一般会存成堆文件外加一些索引信息。
- 计算哈希函数，对每个元组计算散列值，散列值对应的就是存储地址，之后再查询的时候只要查询的属性是计算哈希的属性，那么查询效率就非常高。

- 索引文件：索引（B+树索引）+堆文件/簇集
- 动态哈希：数据结构中的哈希是静态的，映射范围不大，由于数据库系统中的数据会频繁插入、删除，仅仅使用静态哈希，由于映射空间固定，定的太小会有很多溢出，动态哈希采用一套机制，随着文件的增减根据需要动态调整映射空间。
- 栅格结构文件：适用于多属性查询，这本身是一种文件组织方式，采用了多维数组方式存储。有时候查询经常按照学生-学号-年龄访问，这个时候就可以将这三个属性按照三维数组形式存储，在实际应用中，按照三个属性查询的时候就像访问多维数组，速度会很快。
- RAW DISK


堆文件适合第一种访问，因为需要扫描几乎所有的块。但是要查找第二类，查找学生的电话号码，这个时候存成哈希文件比较合适，按照学号进行散列，这样之后就可以直接按照学号直接找到存储位置。

堆文件怎么配合B+树索引？由于堆文件只适合顺序扫描，在查找特定元组的时候，堆文件效率会很低，为了提高系统运行效率，需要在学号属性上建立B+树索引，在数据结构课程中学过，B+树就是平衡树，B+树在普通平衡树上做了一些改进，除了叶节点以外，还有一些双向链表。学号属性建立B+树索引，查询的时候可以根据学号的值判断往哪个方向走，真正的地址是在叶节点上的，当找到所在属性值的叶节点的时候就知道了地址，取到了地址就可以找到存储位置。

B+树的内容在这里不会做过多介绍。B+树和堆文件的结合可以满足很多对数据库的访问。当查询和扫描大量元组的时候可以在堆文件上查找，当需要特定元组的时候，就可以借助B+树索引来完成。这也是关系型数据库底层存储最常见的方式，就是索引+堆文件。索引可以建立多个，例如学号属性、电话号码属性。在数据库设计的时候，根据应用需求，可以指定在哪些属性建立索引，一旦建立了索引，之后的查询效率就会很高。这部分在第六章数据库设计中还会再进行讲解。索引本身虽然是一个好东西，但是索引并不是越多越好，索引是有代价的，系统需要维护索引，相应的插删改操作都会影响索引。

