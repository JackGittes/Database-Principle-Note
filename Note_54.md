## 数据库原理与应用 第五十四讲 触发器的应用

- 作者：**赵明心**
- 日期：**2019年8月28日**

---

### **5.1.5 触发器（续）**

当条件满足的时候就将元组插入到年轻水手那张表。FOR EACH STATEMENT后面还可以添加WHEN判断。ECA规则的用法就是这样的，我们可以定义事件并且监控，然后FOR EACH STATEMENT可以对粒度进行控制。WHEN语句可以加入条件判断。其他的例子可以参考课本。

触发器在其发展历史上有各种实现的方式，ECA规则的实现也不一样：
- 立即执行（Immediate Executation）：当条件发生的时候就立即执行，但是有些数据库系统不是这样的，一个事务中有很多语句，每一个语句都可能触发规则，例如一个update语句，一条规则监视学生表的年轻有没有变化，另一个规则监视家庭地址，一个事务中多条语句牵涉到多个触发器和ECA规则。这些数据库系统认为，一个事件发生触发某个行为的时候可能会抵消其他的一些语句，所以主张不着急去做触发器，等到事务提交的时候再具体地去做触发器。
- 延迟执行（Deferred Executation）：上面已经介绍
- 分离方法：我们认为一个事务本身有很多语句，这些语句上定义的规则比较多，执行规则需要消耗时间，有很大的代价。所以有些数据库把它们分离出来，将ECA规则作为一个衍生的事务，来实现规则的执行。（ECA规则中的动作语句单独分离出来，避免一个事务过大）
- 级联触发器
  - 控制嵌套执行规则
  - 避免非终止
    - 构造触发图（类似于构造事务的等待图，判断触发图是否产生环路）
    - 限制连锁触发的次数（一般从16到64之间取一个数值，当超过此数值则阻止触发并报错）
  - 触发器应该被合理使用（环路带来的连锁触发）

实际数据库系统产品中，用的最多的是**立即执行**的方法，其他触发器执行方法实现的时候或多或少存在困难。与规则执行相关的另外一个事情就是级联触发器。例如在年轻水手表上面再定义一个触发器监视年轻水手表的插入操作，这样就会出现连锁触发。如果在数据库系统定义了若干触发器，这些触发器之间可以连锁，以至于发生了环路，这样就可能发生类似递归调用的时无法终止的问题。触发图判断环路方法的限制过于严格，因为有时候存在环路，但是实际运行的时候并非真的会环路运行。触发器是有规则判断的，所以有时候虽然有环路，但未必真的能触发起来。实际上数据库产品采用了更简单的方法，即限制连锁触发的次数。

### **5.1.6 触发器的实现方法**

- Loosely Coupling：松耦合，有些数据库系统不支持触发器功能，后来为了扩展触发器，就在DBMS外包了一层，用来判断事件发生的时候是不是满足条件，这种方式是打补丁的方式，实现有很大的限制，因为它和DBMS是两个运行空间，在一定程度可以实现DBMS功能，但是不全面。
- Tightly Coupling 紧耦合方法：现在的DB2、Oracle都是紧耦合的。一个触发器的实现基本会涉及到DBMS的各个方面，重写触发器部分几乎需要对DBMS中各个模块进行重新设计和实现。
- 嵌套方法：这是前两种方法的折中，为了实现触发器的功能，对SQL的功能进行了扩充，补充语法树，允许用户定义一些规则。或者使用查询重写的方法，把规则加到用户的查询里面，交给后面的模块执行，这种方法介于前两种之间，虽然修改了DBMS内核，但是不彻底，只是简单的实现。现在主流的数据库产品都是紧耦合方法实现。